#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import subprocess
import sys

def run(*args):
    output = subprocess.check_output(args)
    return output.decode("utf-8").splitlines()

def uninstall(formula):
    dependees = run('brew', 'uses', '--installed', formula)
    if len(dependees) > 0:
        print(f'ERROR, {formula} is used by {", ".join(dependees)}', file=sys.stderr)
        exit(1)

    current_leaves = set(run('brew', 'leaves'))
    expected_leaves = current_leaves - set([formula])

    possible_unused = current_leaves - expected_leaves
    while len(possible_unused) > 0:
        for f in possible_unused:
            dependees = run('brew', 'uses', '--installed', formula)
            if len(dependees) > 0:
                print(f'Ignoring {f}. Used by {", ".join(dependees)}')
            else:
                print(f'Removing {f} ...')
                run('brew', 'uninstall', f)
        possible_unused = set(run('brew', 'leaves')) - expected_leaves


if __name__ == '__main__':
    sys.exit(uninstall(sys.argv[1]) or 0)
